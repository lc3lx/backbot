{% extends "base.html" %}

{% block title %}لوحة التحكم{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>لوحة التحكم</h2>
                    <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">تسجيل الخروج</a>
                </div>

                <div class="mb-4">
                    <h4>إنشاء رابط للمستخدم</h4>
                    <div class="mb-3">
                        <label for="user_id" class="form-label">معرف المستخدم</label>
                        <input type="text" class="form-control" id="user_id">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">نوع المستخدم</label>
                        <select class="form-select" id="user_role">
                            <option value="normal1">مستخدم عادي 1</option>
                            <option value="normal2">مستخدم عادي 2</option>
                        </select>
                    </div>
                    <button onclick="generateLink()" class="btn btn-primary">إنشاء الرابط</button>
                    <div id="linkResult" class="mt-3"></div>
                </div>

                <div class="mb-4">
                    <h4>طلبات خدمة المستخدم</h4>
                    <div class="mb-3">
                        <label for="email" class="form-label">البريد الإلكتروني للمستخدم</label>
                        <input type="email" class="form-control" id="email" dir="ltr">
                    </div>
                    <div class="d-grid gap-2">
                        <button onclick="fetchResidenceCode()" class="btn btn-primary">طلب رمز السكن</button>
                        <button onclick="fetchResidenceUpdateLink()" class="btn btn-primary">طلب رابط تحديث السكن</button>
                        <button onclick="fetchPasswordResetLink()" class="btn btn-primary">طلب استعادة كلمة المرور</button>
                        <button onclick="fetchLoginCode()" class="btn btn-primary">طلب رمز الدخول</button>
                        <button onclick="fetchSuspendedAccountLink()" class="btn btn-primary">طلب تحديث السكن</button>
                    </div>
                    <div id="apiResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const copyBtn = document.getElementById('copyBtn');
        copyBtn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
        setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> نسخ';
        }, 2000);
    });
}

async function callApi(endpoint, email) {
    const requestTypes = {
        'fetch-residence-code': 'رمز السكن',
        'fetch-residence-update-link': 'رابط تحديث السكن',
        'fetch-password-reset-link': 'استعادة كلمة المرور',
        'fetch-login-code': 'رمز الدخول',
        'fetch-suspended-account-link': 'تحديث السكن'
    };

    try {
        const response = await fetch(`/api/${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ account: email })
        });
        
        const data = await response.json();
        const resultDiv = document.getElementById('apiResult');

        if (data.error) {
            resultDiv.innerHTML = `
                <div class="card-body">
                    <div class="alert alert-danger mb-0">
                        ${data.error}
                    </div>
                </div>
            `;
            return;
        }

        let content = '';
        if (data.link) {
            content = data.link;
        } else if (data.code) {
            content = data.code;
        }

        if (!content) {
            resultDiv.innerHTML = `
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        لم يتم العثور على نتيجة لهذا الطلب
                    </div>
                </div>
            `;
            return;
        }

        resultDiv.innerHTML = `
            <div class="card-body">
                <div class="alert alert-success mb-0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>تم جلب البيانات بنجاح</span>
                        <button id="copyBtn" class="btn btn-sm btn-outline-success" onclick="copyToClipboard('${content}')">
                            <i class="fas fa-copy"></i> نسخ
                        </button>
                    </div>
                    <div class="form-control bg-light">${content}</div>
                </div>
            </div>
        `;

        // إضافة السجل إلى الجدول
        const logRow = document.createElement('tr');
        logRow.innerHTML = `
            <td>${new Date().toLocaleTimeString()}</td>
            <td dir="ltr">${email}</td>
            <td>${requestTypes[endpoint]}</td>
            <td>${content}</td>
        `;
        document.getElementById('requestsLog').insertBefore(logRow, document.getElementById('requestsLog').firstChild);
    } catch (error) {
        document.getElementById('apiResult').innerHTML = `
            <div class="alert alert-danger">
                ${error.message}
            </div>
        `;
    }
}

async function fetchResidenceCode() {
    const email = document.getElementById('email').value;
    await callApi('fetch-residence-code', email);
}

async function fetchResidenceUpdateLink() {
    const email = document.getElementById('email').value;
    await callApi('fetch-residence-update-link', email);
}

async function fetchPasswordResetLink() {
    const email = document.getElementById('email').value;
    await callApi('fetch-password-reset-link', email);
}

async function fetchLoginCode() {
    const email = document.getElementById('email').value;
    await callApi('fetch-login-code', email);
}

async function fetchSuspendedAccountLink() {
    const email = document.getElementById('email').value;
    await callApi('fetch-suspended-account-link', email);
}

async function generateLink() {
    const userId = document.getElementById('user_id').value;
    const role = document.getElementById('user_role').value;
    
    try {
        const response = await fetch('/api/generate-subscription-link', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                role: role
            })
        });
        
        const data = await response.json();
        if (data.link) {
            const resultDiv = document.getElementById('linkResult');
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <p>تم إنشاء الرابط بنجاح:</p>
                    <input type="text" class="form-control" value="${data.link}" readonly>
                </div>
            `;
        } else {
            throw new Error('حدث خطأ في إنشاء الرابط');
        }
    } catch (error) {
        document.getElementById('linkResult').innerHTML = `
            <div class="alert alert-danger">
                ${error.message}
            </div>
        `;
    }
}
</script>
{% endblock %}
